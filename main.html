<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="css/mui.min.css" rel="stylesheet"/>
</head>
<body>
	<header id="header" class="mui-bar mui-bar-nav">
		<!-- mui-plus-visible mui-icon-bars-->
		<!--a class="mui-icon mui-icon-contact mui-pull-left" style="color: #999;"></a-->
		<a id="login" class="mui-pull-left" style="padding-top: 13px;" data-href="examples/login/login.html" data-otherHref="examples/login/setting.html">登录</a>
		<a id="info" class="mui-icon mui-icon-info-filled mui-pull-right" style="color: #999;"></a>
		<h1 class="mui-title">谷&nbsp;票</h1>
	</header>
	<div class="mui-content">
        <ul id="menuList" class="mui-table-view mui-grid-view mui-grid-9">
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3">
            	<a href="examples/optionalStock.html">
                    <span class="mui-icon mui-icon-contact"></span>
                    <div class="mui-media-body">自选股</div>
            	</a>
            </li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-email"><span class="mui-badge">5</span></span>
                    <div class="mui-media-body">Email</div></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-chatbubble"></span>
                    <div class="mui-media-body">Chat</div></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-location"></span>
                    <div class="mui-media-body">location</div></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-search"></span>
                    <div class="mui-media-body">Search</div></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-phone"></span>
                    <div class="mui-media-body">Phone</div></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-gear"></span>
                    <div class="mui-media-body">Setting</div></a></li>
            <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-info"></span>
                    <div class="mui-media-body">about</div></a></li>
           <li class="mui-table-view-cell mui-media mui-col-xs-4 mui-col-sm-3"><a href="#">
                    <span class="mui-icon mui-icon-more"></span>
                    <div class="mui-media-body">more</div></a></li>
        </ul>
        <img src="images/test1.jpg" width="100%"/>
	</div>
    <script src="js/mui.min.js"></script>
    <script src="js/public.js"></script>
    <script src="js/login.js"></script>
    <script src="js/zepto_1.1.3.js"></script>
    <script type="text/javascript" charset="utf-8">
    	console.log("??????????????????");
      	mui.init({
      		beforeback: function(){
				console.log("==========================main");
				return true;
			}
      	});
		//处理右上角关于图标的点击事件；
//		var subWebview = null,
//			template = null;
//		$("#login").on("tap", function(){
//			mui.openWindow({
//				url: "examples/index.html",
//				id: "index",
//				show:{
//					aniShow:'zoom-fade-out',
//					duration: 300
//				}
//			});
//		});
//		$("#info").on("tap", function() {
//			mui.openWindow({
//				url: "examples/index.html",
//				id: "index",
//				show:{
//					aniShow:'zoom-fade-out',
//					duration:300
//				}
//			});
//		});
		// H5 plus事件处理
		function plusReady() {
			// 获取本地应用资源版本号
			console.log(plus.runtime.appid);
			console.log("========================================");
			var wgtVer=null;
		    plus.runtime.getProperty(plus.runtime.appid, function(inf){
		        wgtVer = inf.version;
		        console.log("当前应用版本：" + wgtVer);
		    });
		    
		    // 检测更新
			var checkUrl = pConstant.BaseUrl + "gupiao/check.php";
			function checkUpdate(){
			    plus.nativeUI.showWaiting("检测更新...");
			    var xhr = new XMLHttpRequest();
			    xhr.onreadystatechange = function(){
			        switch(xhr.readyState) {
			            case 4:
			            plus.nativeUI.closeWaiting();
			            if (xhr.status == 200) {
			                console.log("检测更新成功：" + xhr.responseText);
			                var newVer = xhr.responseText;
			                var newVerObj = JSON.parse(newVer);
			                var newVersion = newVerObj["version"];
			                console.log(wgtVer + "=" + newVersion);
			                if(wgtVer&&newVersion&&(wgtVer!=newVersion)){
			                    //downWgt();  // 下载升级包
			                    
				                var downloadUrl = pConstant.BaseUrl + "gupiao/update/gupiao" + newVersion + ".apk"; // 下载文件地址
								var dtask = plus.downloader.createDownload( downloadUrl, {}, function ( d, status ) {
								    if ( status == 200 ) { // 下载成功
								        var path = d.filename;
								        console.log(d.filename);
								        plus.runtime.install(path);  // 安装下载的apk文件
								    } else {//下载失败
								        alert( "Download failed: " + status ); 
								    }  
								});
								dtask.start(); 
			                }else{
			                    plus.nativeUI.alert("无新版本可更新！");
			                }
			            } else {
			                console.log("检测更新失败！");
			                plus.nativeUI.alert("检测更新失败！");
			            }
			            break;
			            default:
			            break;
			        }
			    }
			    xhr.open('GET',checkUrl);
			    xhr.send();
			}
			checkUpdate();
			// 下载wgt文件
//			var wgtUrl = pConstant.BaseUrl + "gupiao/update/H52060C73.wgt";
//			function downWgt() {
//			    plus.nativeUI.showWaiting("下载wgt文件...");
//			    plus.downloader.createDownload( wgtUrl, {filename:"_doc/update/"}, function(d,status){
//			        if ( status == 200 ) { 
//			            console.log("下载wgt成功："+d.filename);
//			            installWgt(d.filename); // 安装wgt包
//			        } else {
//			            console.log("下载wgt失败！");
//			            plus.nativeUI.alert("下载wgt失败！");
//			        }
//			        plus.nativeUI.closeWaiting();
//			    }).start();
//			}
			// 更新应用资源
//			function installWgt(path){
//			    plus.nativeUI.showWaiting("安装wgt文件...");
//			    plus.runtime.install(path,{},function(){
//			        plus.nativeUI.closeWaiting();
//			        console.log("安装wgt文件成功！");
//			        plus.nativeUI.alert("应用资源更新完成！",function(){
//			            plus.runtime.restart();
//			        });
//			    },function(e){
//			        plus.nativeUI.closeWaiting();
//			        console.log("安装wgt文件失败["+e.code+"]："+e.message);
//			        plus.nativeUI.alert("安装wgt文件失败["+e.code+"]："+e.message);
//			    });
//			}
			
			var types = {}; 
			types[plus.networkinfo.CONNECTION_UNKNOW] = "Unknown connection"; 
			//types[plus.networkinfo.CONNECTION_NONE] = "None connection";
			types[plus.networkinfo.CONNECTION_NONE] = "网络错误,请检查手机网络设置或尝试重启手机。";
			types[plus.networkinfo.CONNECTION_ETHERNET] = "Ethernet connection"; 
			types[plus.networkinfo.CONNECTION_WIFI] = "WiFi connection"; 
			types[plus.networkinfo.CONNECTION_CELL2G] = "Cellular 2G connection"; 
			types[plus.networkinfo.CONNECTION_CELL3G] = "Cellular 3G connection"; 
			types[plus.networkinfo.CONNECTION_CELL4G] = "Cellular 4G connection";
			var getCurrentType = plus.networkinfo.getCurrentType();
			if (getCurrentType == plus.networkinfo.CONNECTION_NONE) {
				alert(types[plus.networkinfo.getCurrentType()]);
			}
			console.log( "Network: " + plus.networkinfo.getCurrentType() );
			console.log( "Network: " + types[plus.networkinfo.getCurrentType()] );
		}
		if (window.plus) {
			plusReady();
		} else {
			document.addEventListener("plusready", plusReady, false);
		}
		var OpenWClass = "open-window-other";
		var state = app.getState();
		console.log(JSON.stringify(state));
		console.log(state["userName"]);
		if ( state["userName"] != undefined && state["userName"] != "" ) {
			$("#login").html(state["userName"]).addClass(OpenWClass);
		}
		$('#menuList,#header').on('tap', 'a', function() {
			var aniShow = "pop-in";
			var $this = $(this);
			var id = $this.attr('data-href');
			var href = $this.attr('data-href');
			console.log(!$this.hasClass(OpenWClass));
			if ( $this.hasClass(OpenWClass) ) {
				id = $this.attr('data-otherHref');
				href = $this.attr('data-otherHref');
				mui.openWindow({
					id: id,
					url: href,
					styles: {
						popGesture: 'close'
					},
					show: {
						aniShow: aniShow
					},
					waiting: {
						autoShow: false
					}
				});
			} else {
				mui.openWindow({
					id: id,
					url: href,
					styles: {
						popGesture: 'close'
					},
					show: {
						aniShow: aniShow
					},
					waiting: {
						autoShow: false
					}
				});
			}
		});
		//document.getElementById('info').addEventListener('tap', function() {
//			if (!mui.os.plus) {
//				mui.openWindow({
//					url: "examples/info.html",
//					id: "info",
//					show: {
//						aniShow: 'zoom-fade-out',
//						duration: 300
//					}
//				});
//				return;
//			}
//			if (subWebview == null) {
//				//获取共用父窗体
//				template = plus.webview.getWebviewById("default-main");
//			}
//			if (template) {
//				subWebview = template.children()[0];
//				subWebview.loadURL('examples/info.html');
//				//修改共用父模板的标题
//				mui.fire(template, 'updateHeader', {
//					title: '关于',
//					showMenu: false
//				});
//				template.show('slide-in-right', 150);
//			}
//			mui.openWindow({
//				url: "examples/index.html",
//				id: "index",
//				show:{
//					aniShow:'zoom-fade-out',
//					duration:300
//				}
//			});
//		});
    </script>
</body>
</html>